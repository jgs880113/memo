select *
  from TEST A
 WHERE OCCR_DT >= '202501010920'
     AND OCCR_DT <= '202504010920'
     AND STRTITLE = 'apple'
     AND (SIP, STRTITLE) NOT IN (SELECT IP, SIG_NM FROM EXIP WHERE(FLAG = '1' OR FLAG = '2'))
     AND (DIP, STRTITLE) NOT IN (SELECT IP, SIG_NM FROM EXIP WHERE(FLAG = '1' OR FLAG = '3'))
     AND SIP NOT IN (SELECT IP FROM EXIP WHERE(FLAG = '1' OR FLAG = '2'))
     AND DIP NOT IN (SELECT IP FROM EXIP WHERE(FLAG = '1' OR FLAG = '3'))
;



SELECT *
  FROM TEST
 WHERE OCCR_DT >= '202501010920'
   AND OCCR_DT <= '202504010920'
   AND STRTITLE = 'apple'
   AND dictGetOrDefault('exip_dict_ip_sig', 'flag', (SIP, STRTITLE), 0) NOT IN (1, 2)
   AND dictGetOrDefault('exip_dict_ip_sig', 'flag', (DIP, STRTITLE), 0) NOT IN (1, 3)
   AND NOT has(dictGet('exip_dict_ip_flag12_set', 'ip_set', SIP), SIP)
   AND NOT has(dictGet('exip_dict_ip_flag13_set', 'ip_set', DIP), DIP)
;

CREATE DICTIONARY exip_dict_ip_flag12_set
(
    IP String,
    ip_set Array(String)
)
PRIMARY KEY IP
SOURCE(CLICKHOUSE(
    QUERY 'SELECT IP, groupArray(IP) AS ip_set FROM EXIP WHERE FLAG IN (1, 2) GROUP BY IP'
))
LAYOUT(FLAT())
LIFETIME(MIN 30 MAX 60);

CREATE DICTIONARY exip_dict_ip_flag13_set
(
    IP String,
    ip_set Array(String)
)
PRIMARY KEY IP
SOURCE(CLICKHOUSE(
    QUERY 'SELECT IP, groupArray(IP) AS ip_set FROM EXIP WHERE FLAG IN (1, 3) GROUP BY IP'
))
LAYOUT(FLAT())
LIFETIME(MIN 30 MAX 60);


ALTER TABLE default.TEST
MODIFY TTL parseDateTimeBestEffort(OCCR_DT) + INTERVAL 3 MONTH DELETE;
