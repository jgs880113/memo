âœ… Kafka ë©”ì‹œì§€ ì˜ˆì‹œ êµ¬ì¡° (Debezium ìŠ¤íƒ€ì¼)
json
ë³µì‚¬
í¸ì§‘
{
  "op": "u",
  "before": {
    "id": 101
  },
  "after": {
    "id": 101,
    "name": "new_name",
    "email": "new@email.com"
  },
  "ts_ms": 1719200000000
}
âœ… ì²˜ë¦¬ íë¦„ ì •ë¦¬
op == 'u'ì´ë©´ handle_update(row) í•¨ìˆ˜ í˜¸ì¶œ

beforeì—ì„œ PK ì»¬ëŸ¼ ì¶”ì¶œ â†’ WHERE id = 101

afterì—ì„œ ë³€ê²½ëœ ì»¬ëŸ¼ë§Œ ì¶”ì¶œ â†’ SET name = ..., email = ...

ClickHouseì— ALTER TABLE ... UPDATE ì „ì†¡

âœ… PySpark foreachBatch ì˜ˆì‹œ
python
ë³µì‚¬
í¸ì§‘
def handle_update(row, client):
    before = row['before']
    after = row['after']

    if not before or not after:
        print("[WARN] UPDATE ì´ë²¤íŠ¸ì— before ë˜ëŠ” after ëˆ„ë½")
        return

    # SET ì ˆ êµ¬ì„±
    set_clauses = []
    params = {}
    for key, value in after.items():
        if key not in before or before[key] != value:
            set_clauses.append(f"{key} = %({key})s")
            params[key] = value

    # WHERE ì ˆ (PK ê¸°ì¤€)
    where_clauses = []
    for key, value in before.items():
        where_clauses.append(f"{key} = %({key}_pk)s")
        params[f"{key}_pk"] = value

    if not set_clauses:
        print("[INFO] ë³€ê²½ëœ í•„ë“œ ì—†ìŒ, UPDATE ìƒëµ")
        return

    sql = f"""
    ALTER TABLE your_table
    UPDATE {', '.join(set_clauses)}
    WHERE {' AND '.join(where_clauses)};
    """
    client.execute(sql, params)
âœ… ì „ì²´ êµ¬ì¡° ì˜ˆì‹œ
python
ë³µì‚¬
í¸ì§‘
def update_clickhouse(batch_df, batch_id):
    from clickhouse_driver import Client
    client = Client(
        host='your_host',
        port=9000,
        user='default',
        password='your_password',
        database='your_db'
    )

    for row in batch_df.collect():
        handle_update(row.asDict(), client)
ğŸ”’ ë³´ì•ˆ ë° ì•ˆì •ì„± ê³ ë ¤
í•­ëª©	ì²˜ë¦¬ ë°©ë²•
SQL Injection	%(key)s ë°©ì‹ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì‚¬ìš© âœ”
ì˜ˆì™¸ ì²˜ë¦¬	try/exceptë¡œ ê° row ì²˜ë¦¬ ì‹œ ì—ëŸ¬ ë¡œê¹… âœ”
ë³€ê²½ ì—†ëŠ” ê²½ìš° ìƒëµ	before == afterë©´ UPDATE ìƒëµ ì²˜ë¦¬ âœ”
pk ë¯¸ì¡´ì¬ ì—ëŸ¬	beforeê°€ ë¹„ë©´ WARNING ë¡œê·¸ë§Œ ì¶œë ¥ âœ”
