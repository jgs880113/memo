-- PKT_SEQ 접두(언더스코어 앞)에서 YYYYMM을 뽑아 월 파티션으로 저장
CREATE TABLE excluded_pkt_seq_monthly
(
  month   UInt32,   -- 예: 202503
  pkt_seq String
)
ENGINE = MergeTree
PARTITION BY month
ORDER BY (month, pkt_seq);

CREATE MATERIALIZED VIEW mv_excluded_pkt_seq_monthly
TO excluded_pkt_seq_monthly AS
SELECT
  -- '202509170961_252523' -> 왼쪽 토큰 = '202509170961' -> 앞 6자리 = '202509'
  toUInt32( substring(splitByChar('_', pkt_seq)[1], 1, 6) ) AS month,
  pkt_seq
FROM TEST_LOG;   -- PKT_SEQ만 있는 로그 테이블 (String)



/* ===== 파라미터 ===== */
WITH
    toDateTime('2025-03-15 00:00:00') AS dt_from,
    toDateTime('2025-05-03 23:59:59') AS dt_to,
    'abc' AS wanted_title,
    toYYYYMM(dt_from) AS m_from,
    toYYYYMM(dt_to)   AS m_to

/* ===== 본문 ===== */
, base AS (
    /* TEST */
    SELECT PKT_SEQ, OCCR_DT, STRTITLE, SIP, DIP
    FROM TEST
    PREWHERE OCCR_DT BETWEEN dt_from AND dt_to
      AND STRTITLE = wanted_title
      AND PKT_SEQ NOT IN (
        SELECT pkt_seq
        FROM excluded_pkt_seq_monthly
        WHERE month BETWEEN m_from AND m_to        -- ★ 월跨 구간 대응
      )

    UNION ALL

    /* TEST2 */
    SELECT PKT_SEQ, OCCR_DT, STRTITLE, SIP, DIP
    FROM TEST2
    PREWHERE OCCR_DT BETWEEN dt_from AND dt_to
      AND STRTITLE = wanted_title
      AND PKT_SEQ NOT IN (
        SELECT pkt_seq
        FROM excluded_pkt_seq_monthly
        WHERE month BETWEEN m_from AND m_to
      )
)

/* 날짜/시각별로 먼저 집계: 그 시각의 max(SIP) */
, per_instant AS (
    SELECT
      STRTITLE,
      OCCR_DT,
      max(SIP) AS max_sip
    FROM base
    GROUP BY STRTITLE, OCCR_DT
)

/* ===== KEEP LAST 동등 결과 ===== */
SELECT
  STRTITLE,
  argMax(max_sip, (OCCR_DT, max_sip)) AS max_sip_at_last_dt,  -- = MAX(SIP) KEEP ... LAST
  argMax(OCCR_DT,  OCCR_DT)           AS last_occr_dt         -- 참고: 마지막 시각
FROM per_instant
GROUP BY STRTITLE;
